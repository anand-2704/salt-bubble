<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Salt Bubble Deals</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="header">
    <div class="container">
      <h1>Salt Bubble</h1>
      <p class="sub">Best deals across top stores — updated often.</p>

      <div class="controls">
        <input id="search" type="search" placeholder="Search deals (e.g., iPad, TV, headphones)..." />
        <select id="storeFilter">
          <option value="all">All stores</option>
        </select>
        <select id="categoryFilter">
          <option value="all">All categories</option>
        </select>
      </div>

      <div class="disclosure">
        <strong>Disclosure:</strong> Some links may be affiliate links. If you buy through them, we may earn a commission.
      </div>
    </div>
  </header>

  <main class="container">
    <div id="status" class="status">Loading deals…</div>
    <section id="grid" class="grid"></section>
  </main>

  <footer class="footer">
    <div class="container">
      <small>© <span id="year"></span> Salt Bubble • Deal listings are informational • Prices can change quickly.</small>
    </div>
  </footer>

<script>
  const grid = document.getElementById("grid");
  const statusEl = document.getElementById("status");
  const searchEl = document.getElementById("search");
  const storeFilterEl = document.getElementById("storeFilter");
  const categoryFilterEl = document.getElementById("categoryFilter");
  document.getElementById("year").textContent = new Date().getFullYear();

  let deals = [];

  function formatPrice(value) {
    if (value === null || value === undefined || value === "") return "";
    return new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" }).format(value);
  }

  function uniqueValues(list, key) {
    return Array.from(new Set(list.map(x => x[key]).filter(Boolean))).sort();
  }

  function populateFilters() {
    const stores = uniqueValues(deals, "store");
    const categories = uniqueValues(deals, "category");

    for (const s of stores) {
      const opt = document.createElement("option");
      opt.value = s; opt.textContent = s;
      storeFilterEl.appendChild(opt);
    }
    for (const c of categories) {
      const opt = document.createElement("option");
      opt.value = c; opt.textContent = c;
      categoryFilterEl.appendChild(opt);
    }
  }

  function matchesFilters(d) {
    const q = searchEl.value.trim().toLowerCase();
    const store = storeFilterEl.value;
    const cat = categoryFilterEl.value;

    const text = `${d.title} ${d.store} ${d.category} ${d.tags?.join(" ") || ""}`.toLowerCase();
    const qOk = !q || text.includes(q);
    const storeOk = (store === "all") || d.store === store;
    const catOk = (cat === "all") || d.category === cat;
    return qOk && storeOk && catOk;
  }

  function render() {
    const filtered = deals.filter(matchesFilters)
      .sort((a,b) => (b.score ?? 0) - (a.score ?? 0)); // score = your “hotness” ranking

    grid.innerHTML = "";
    statusEl.textContent = filtered.length ? "" : "No deals match your filters.";

    for (const d of filtered) {
      const card = document.createElement("article");
      card.className = "card";

      const badge = d.badge ? `<span class="badge">${d.badge}</span>` : "";
      const oldPrice = d.oldPrice ? `<span class="old">${formatPrice(d.oldPrice)}</span>` : "";
      const price = d.price ? `<span class="price">${formatPrice(d.price)}</span>` : "";
      const discount = (d.oldPrice && d.price) ? 
        `<span class="off">${Math.round((1 - (d.price / d.oldPrice)) * 100)}% OFF</span>` : "";

      card.innerHTML = `
        <div class="card-top">
          <div>
            <h2 class="title">${d.title}</h2>
            <div class="meta">
              <span class="pill">${d.store}</span>
              <span class="pill">${d.category}</span>
              ${badge}
            </div>
          </div>
        </div>

        <div class="prices">
          ${price} ${oldPrice} ${discount}
        </div>

        <p class="desc">${d.description || ""}</p>

        <div class="actions">
          <a class="btn" href="${d.url}" target="_blank" rel="noopener noreferrer nofollow sponsored">
            View Deal
          </a>
          <span class="small">
            Updated: ${d.updated || "—"}
          </span>
        </div>
      `;
      grid.appendChild(card);
    }
  }

  async function loadDeals() {
    try {
      const res = await fetch("deals.json", { cache: "no-store" });
      deals = await res.json();
      populateFilters();
      statusEl.textContent = "";
      render();
    } catch (e) {
      statusEl.textContent = "Failed to load deals.json. Check file name and JSON format.";
      console.error(e);
    }
  }

  searchEl.addEventListener("input", render);
  storeFilterEl.addEventListener("change", render);
  categoryFilterEl.addEventListener("change", render);

  loadDeals();
</script>
</body>
</html>
